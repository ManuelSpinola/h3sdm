---
title: "h3sdm workflow for a species distribution modeling for a species using a single model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


# Introduction

This tutorial demonstrates a complete workflow for species distribution modeling (SDM) for a single species using h3sdm and related packages. We cover data preparation, model fitting, spatial cross-validation, prediction, and feature importance analysis.

The following example requires the 'paisaje' package from GitHub 

```{r, eval=FALSE}
install.packages("remotes")
remotes::install_github("ManuelSpinola/paisaje")
```


```{r}
#| message: false
#| warning: false
# Load the required packages
library(h3sdm)
library(paisaje)
library(crgeo)
library(tidyverse)
library(here)
library(tidymodels)
library(spatialsample)
library(sf)
library(terra)
library(tidyterra)
library(DALEXtra)
library(ingredients)
library(exactextractr)
library(workflowsets)
library(themis)
```


# 1. Define the Area of Interest

We start by defining the geographical area for modeling.

```{r}
cr <- cr_outline_c |>
  dplyr::select(-COUNTRY)
```


# 2. Load Environmental Predictors

We use WorldClim historic bioclimatic variables as environmental predictors.

```{r}
bio <- paisaje::get_worldclim_historic(var = "bio", res = 2.5, aoi = cr) |>
  drop_na()
```


# 3. Load Species Occurrence Data

Here we fetch presence-absence data for the species of interest (Silverstoneia flotator).



```{r}
records <- h3sdm_pa("Silverstoneia flotator", cr, res = 7, n_neg = 300)
```


```{r}
records
```

```{r}
table(records$presence)
```

```{r}
ggplot() +
  geom_sf(data = records, aes(fill = presence))
```

# 4. Prepare Predictors

Select relevant predictors and clean column names.

```{r}
predictors <- h3sdm_predictors(cr, 
                    res = 7, 
                    num_rasters = bio)
```

```{r}
predictors <- predictors |>
  rename_with(
    .cols = contains("bio_"),
    .fn = ~ paste0("Bio", str_extract(., "\\d+$"))
  )
```


```{r}
predictors <- predictors |>
  dplyr::select(h3_address, Bio1, Bio12, Bio15, geometry)
```


```{r}
ggplot() +
  theme_minimal() +
  geom_sf(data = predictors, aes(fill = Bio1)) +
  scale_fill_viridis_c(option = "B")
```


# 5. Combine Records and Predictors

Merge species occurrence records with environmental predictors.

```{r}
dat <- h3sdm_data(records, predictors)
```


# 6. Spatial Cross-Validation

Define spatial blocks for cross-validation to account for spatial autocorrelation.

```{r}
scv <- h3sdm_spatial_cv(dat, v = 5, repeats = 1)
```

```{r}
scv
```

```{r}
autoplot(scv)
```


# 7. Define Recipe and Model

Create a modeling recipe and specify the classification model.

```{r}
receta <- h3sdm_recipe(dat) |>
  themis::step_smote(presence)
```

```{r}
receta
```


```{r}
modelo <- parsnip::logistic_reg() %>%
  parsnip::set_engine("glm") %>%
  parsnip::set_mode("classification")
```


```{r}
wf <- h3sdm_workflow(modelo, receta)
```


```{r}
wf
```


# 8. Fit the Model

Fit the model using the spatial cross-validation scheme and presence data.

```{r}
presence_data <- dat %>%
  dplyr::filter(presence == 1)
```


```{r}
f <- h3sdm_fit_model(wf, scv, presence_data)
```

# 9. Evaluate Model Performance

Evaluate performance using cross-validated metrics like ROC-AUC, accuracy, or TSS.

```{r}
evaluation_metrics <- h3sdm_eval_metrics(
  fitted_model  = f$cv_model,
  presence_data = presence_data
)
evaluation_metrics
```

```{r}
ggplot(evaluation_metrics, aes(.metric, mean)) +
  theme_minimal() +
  geom_col(width = 0.03) +
  geom_point(size = 3) +
  ylim(0,1)
```


# 10. Make Predictions

Generate spatial predictions for the species distribution across the study area.

```{r}
p <- h3sdm_predict(f, predictors)
```

# 11. Map 

```{r}
ggplot() +
  theme_minimal() +
  geom_sf(data = p, aes(fill = prediction)) +
  scale_fill_viridis_c(option = "B", direction = -1)
```

# 11. Feature Importance

Finally, evaluate which predictors contributed most to the model.

```{r}
e <- h3sdm_explain(f$final_model, data = dat)
```

```{r}
predictors_to_evaluate <- setdiff(names(e$data), c("h3_address", "x", "y", "presence"))
```


```{r}
# Now, use this vector in your function call
var_imp <- model_parts(
  explainer = e,
  variables = predictors_to_evaluate
)
```


```{r}
var_imp
```

```{r}
plot(var_imp)
```


# Conclusion

This tutorial demonstrated a complete SDM workflow for a single species:

	•	Defining the study area

	•	Loading and preparing environmental predictors

	•	Fetching species occurrence data

	•	Building a predictive model with spatial cross-validation

	•	Evaluating performance and predictions

	•	Assessing variable importance

This workflow can be adapted for multiple species or more complex models.

